# ğŸ“ ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ - Patient & Relative

## ğŸ¯ Ø§Ù„ÙÙ‡Ø±Ø³
1. [Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©](#Ø§Ù„Ù…Ø´ÙƒÙ„Ø©-Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
2. [ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù…Ø±ÙŠØ¶](#ØªØ­Ù„ÙŠÙ„-Ø§Ù„ÙƒÙˆØ¯-Ù„Ù„Ù…Ø±ÙŠØ¶-patient)
3. [ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù‚Ø±ÙŠØ¨](#ØªØ­Ù„ÙŠÙ„-Ø§Ù„ÙƒÙˆØ¯-Ù„Ù„Ù‚Ø±ÙŠØ¨-relative-family)
4. [ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø·Ø¨ÙŠØ¨](#ØªØ­Ù„ÙŠÙ„-Ø§Ù„ÙƒÙˆØ¯-Ù„Ù„Ø·Ø¨ÙŠØ¨-doctor)
5. [Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (Static)](#Ø§Ù„Ù…Ù†Ø·Ù‚-Ø§Ù„Ø­Ø§Ù„ÙŠ--static)
6. [ÙƒÙŠÙÙŠØ© ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©](#ÙƒÙŠÙÙŠØ©-ØªØ­ÙˆÙŠÙ„Ù‡Ø§-Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
7. [Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ù„Ù„ØªØ­Ø¯ÙŠØ«](#Ø§Ù„Ø®Ø·Ø©-Ø§Ù„ØªÙ‚Ù†ÙŠØ©-Ù„Ù„ØªØ­Ø¯ÙŠØ«)

---

## âŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

### Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ù‡Ù† (Hard-coded / Static):
Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ **Ù…ÙƒØªÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ Ø«Ø§Ø¨Øª** ÙÙŠ Ø§Ù„ÙƒÙˆØ¯:
- âœ— Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¢Ù…Ù†Ø© (Safe Zones) Ù…ÙØ­ÙÙˆØ¸Ø© Ø¨Ø£Ø±Ù‚Ø§Ù… Ø«Ø§Ø¨ØªØ©
- âœ— Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ static (Ù„Ø§ ÙŠØªØºÙŠØ± Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Refresh ÙŠØ¯ÙˆÙŠ)
- âœ— Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù€ Database Ø£Ùˆ API
- âœ— Ø§Ù„ØªØ§Ø±ÙŠØ® (History) Ù…ÙƒØªÙˆØ¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§
- âœ— Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ (Real-time Updates)
- âœ— Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ ØªÙÙÙ‚Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª

---

## ğŸ“± ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù…Ø±ÙŠØ¶ (Patient)

### Ø§Ù„Ù…Ù„Ù: `lib/screens/patient/live_tracking_screen.dart`

#### ğŸ”´ **Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Static)**

```dart
class _LiveTrackingScreenState extends State<LiveTrackingScreen> {
  // 1ï¸âƒ£ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
  Position? _pos;              // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
  DateTime? _lastUpdated;      // Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
  String? _address;            // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¬ÙŠÙˆ-ÙƒÙˆØ¯ Ù…Ø¹ÙƒÙˆØ³)

  // 2ï¸âƒ£ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¢Ù…Ù†Ø© - **Ø«Ø§Ø¨ØªØ© ÙˆÙ…ÙƒØªÙˆØ¨Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯**
  final List<_SafeZone> _safeZones = const [
    _SafeZone(
      name: 'Home',
      lat: 31.034350,
      lng: 30.471819,
      radiusMeters: 20,
      isActive: true,
    ),
  ];

  // 3ï¸âƒ£ Ø±Ù‚Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ - **Ù…Ø­ÙƒÙˆÙ… Ø¨Ø§Ù„ÙƒÙˆØ¯**
  final String _emergencyPhone = '+201210402952';
}
```

#### ğŸ“‹ **Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø±ÙŠØ¶**

| Ø§Ù„Ù‚Ø³Ù… | Ø§Ù„ØºØ±Ø¶ | Ø§Ù„Ø­Ø§Ù„Ø© |
|------|-------|--------|
| **Map Display** | Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø¯Ø§Ø¦Ø±ÙŠ Ø¨Ø³ÙŠØ· | Static illustration |
| **Status Badge** | ğŸŸ¢ Safe / ğŸ”´ Outside | ÙŠØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ `_insideAnyZone` |
| **Location Info** | Ø¹Ù†ÙˆØ§Ù† + Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« | ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ø¨Ù€ Geolocator |
| **Refresh Button** | ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§ | ÙŠØ¯ÙˆÙŠ ÙÙ‚Ø· |
| **Emergency Alert** | Ø¥Ø±Ø³Ø§Ù„ SOS | ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¹Ø¨Ø± WhatsApp/SMS |

#### ğŸ”§ **Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ:**

```dart
// 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
@override
void initState() {
  super.initState();
  _getCurrentLocation(); // ÙŠØ­Ø¯Ø« **Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·**
}

// 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù…Ø§Ù†
bool get _insideAnyZone {
  if (_pos == null) return true;
  for (final z in _safeZones) {
    if (!z.isActive) continue;
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ù€ Haversine
    final d = _distanceMeters(_pos!.latitude, _pos!.longitude, z.lat, z.lng);
    if (d <= z.radiusMeters) return true; // ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø© âœ…
  }
  return false; // Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© âŒ
}

// 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙÙ‚Ø·
Future<void> _getCurrentLocation() async {
  // Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù€ Geolocator
  // Ø¹ÙƒØ³ Ø§Ù„Ø¬ÙŠÙˆ-ÙƒÙˆØ¯ (Reverse Geocoding) Ø¨Ù€ geocoding package
}
```

#### âŒ **Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:**
1. **Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø§Ø¹Ø© ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Timer)** - Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠÙØ¬Ù„Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
2. **Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¢Ù…Ù†Ø© Ø«Ø§Ø¨ØªØ©** - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø§Ø·Ù‚ Ø¬Ø¯ÙŠØ¯Ø©
3. **Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù€ Backend** - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·
4. **Emergency contact Ù…Ø­ÙƒÙˆÙ… Ø¨Ø§Ù„ÙƒÙˆØ¯** - Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§

---

## ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù‚Ø±ÙŠØ¨ (Relative / Family)

### Ø§Ù„Ù…Ù„Ù: `lib/screens/family/family_tracking_screen.dart`

#### ğŸ”´ **Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Static)**

```dart
class _FamilyTrackingScreenState extends State<FamilyTrackingScreen> {
  // 1ï¸âƒ£ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ - Ø«Ø§Ø¨Øª
  final String _patientName = 'Margaret Smith';

  // 2ï¸âƒ£ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ - Ø«Ø§Ø¨Øª ÙˆÙ…Ø­Ø¯Ø¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§
  _LatLng _patient = const _LatLng(31.041243, 30.465516);
  DateTime _lastUpdated = DateTime.now();

  // 3ï¸âƒ£ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¢Ù…Ù†Ø© - **4 Ù…Ù†Ø§Ø·Ù‚ Ù…ÙƒØªÙˆØ¨Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯**
  final List<_SafeZone> _safeZones = [
    _SafeZone(
      name: 'Home',
      address: '123 mostashfa Street, damanhour',
      lat: 31.041243,
      lng: 30.465516,
      radiusMeters: 200,
      isActive: true,
    ),
    _SafeZone(name: 'Park', ...),
    _SafeZone(name: 'Hospital', ...),
    _SafeZone(name: 'Church', ...),
  ];

  // 4ï¸âƒ£ Ø§Ù„Ø³Ø¬Ù„ - **4 Ù…Ø¯Ø®Ù„Ø§Øª Ø«Ø§Ø¨ØªØ©**
  final List<_HistoryEntry> _history = [
    _HistoryEntry(place: 'Home', ..., lat: 31.041243, lng: 30.465516),
    _HistoryEntry(place: 'Park', ...),
    // ...
  ];
}
```

#### ğŸ“‹ **Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù‚Ø±ÙŠØ¨ - 3 Tabs**

| Ø±Ù‚Ù… Tab | Ø§Ù„Ø§Ø³Ù… | Ø§Ù„ØºØ±Ø¶ | Ø§Ù„Ø­Ø§Ù„Ø© |
|--------|------|-------|--------|
| 0 | **Live** | Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„ÙÙˆØ±ÙŠ | Static map illustration |
| 1 | **Safe Zones** | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¢Ù…Ù†Ø© | Ù…Ø­Ø±Ø± ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (ÙÙŠ session ÙÙ‚Ø·) |
| 2 | **History** | Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© | Static data |

#### ğŸ” **Tab 0: Live Tracking**

```dart
// Ø¹Ø±Ø¶:
// - Ø®Ø±ÙŠØ·Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© (Ù„ÙŠØ³Øª Ø®Ø±ÙŠØ·Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©)
// - Ø­Ø§Ù„Ø© (Safe/Outside)
// - Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ù…ÙƒØªÙˆØ¨ Ø¨Ø§Ù„ÙƒÙˆØ¯)
// - Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« (ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯)
// - Ø²Ø± "Get Directions to Patient"
// - Ø²Ø± Refresh (ÙŠØ­Ø§ÙƒÙŠ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)

void _refreshLocation() {
  // Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø±ÙƒØ© ØµØºÙŠØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
  final r = Random();
  final deltaLat = (r.nextDouble() - 0.5) / 5000; // Ø­Ø±ÙƒØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§
  final deltaLng = (r.nextDouble() - 0.5) / 5000;
  setState(() {
    _patient = _LatLng(_patient.lat + deltaLat, _patient.lng + deltaLng);
    _lastUpdated = DateTime.now();
  });
}
```

#### ğŸ”§ **Tab 1: Safe Zones Editor**

```dart
// Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:
// âœ… ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ù…Ù†Ø·Ù‚Ø© (Toggle)
// âœ… Ø­Ø°Ù Ù…Ù†Ø·Ù‚Ø© (Delete)
// âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© (Add) - Ø¨Ù€ Modal Sheet

void _openAddSafeZoneSheet({
  required void Function(_SafeZone) onAdd,
}) {
  // ÙŠØ³Ù…Ø­ Ø¨Ø¥Ø¯Ø®Ø§Ù„:
  // - Ø§Ù„Ø§Ø³Ù…
  // - Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  // - Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (lat/lng)
  // - Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± (radius) Ø¨Ù€ Slider
  // - ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù
  
  // âš ï¸ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª **ØªÙØ­ÙØ¸ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©**
  // Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ â†’ ØªÙÙÙ‚Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
}
```

#### ğŸ“œ **Tab 2: History**

```dart
// Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ©:
// - 4 Ù…Ø¯Ø®Ù„Ø§Øª Ø«Ø§Ø¨ØªØ© Ù…ÙƒØªÙˆØ¨Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯
// - Ù…ÙƒØ§Ù†ØŒ Ø¹Ù†ÙˆØ§Ù†ØŒ ÙˆÙ‚ØªØŒ Ù…Ø¯Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©
// - Ø²Ø± "Directions" Ù„ÙƒÙ„ Ù…Ø¯Ø®Ù„
```

#### âŒ **Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:**
1. **Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø«Ø§Ø¨Øª** - ÙŠÙØ­Ø¯Ø« Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Refresh
2. **Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Backend** - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙˆØªÙÙÙ‚Ø¯ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
3. **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©** - ØªÙØ¹Ø¯ÙÙ‘Ù„ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙ‚Ø· (Session state)
4. **Ø§Ù„Ø³Ø¬Ù„ Ø«Ø§Ø¨Øª** - Ù„Ø§ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ù…Ø±ÙŠØ¶
5. **Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ©** - ÙŠØ¬Ø¨ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Refresh ÙŠØ¯ÙˆÙŠÙ‹Ø§

---

## ğŸ‘¨â€âš•ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø·Ø¨ÙŠØ¨ (Doctor)

### Ø§Ù„Ù…Ù„Ù: `lib/screens/doctor/doctor_tracking_screen.dart`

#### ğŸ”´ **Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Static)**

```dart
class _DoctorTrackingScreenState extends State<DoctorTrackingScreen> {
  int _selectedIndex = 0; // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

  // **3 Ù…Ø±Ø¶Ù‰ Ù…ÙƒØªÙˆØ¨ÙŠÙ† Ø¨Ø§Ù„ÙƒÙˆØ¯**
  late final List<_Patient> _patients = [
    _Patient(
      name: 'Margaret Smith',
      locationLabel: 'At Home',
      position: const _LatLng(37.3318, -122.0312),
      lastUpdated: DateTime.now().subtract(const Duration(minutes: 2)),
      safeZones: [
        _SafeZone(name: 'Home', address: '123 Oak Street, Springfield', ...),
        _SafeZone(name: 'Park', ...),
        _SafeZone(name: 'Hospital', ...),
      ],
      history: [
        _HistoryEntry(place: 'Home', ...),
        _HistoryEntry(place: 'Park', ...),
      ],
    ),
    _Patient(name: 'John Davis', ...),
    _Patient(name: 'Mary Taylor', ...),
  ];
}
```

#### ğŸ“‹ **Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø·Ø¨ÙŠØ¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dropdown: Select Patient [Margaret Smith â–¼]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Map Display (Static)               â”‚
â”‚  Status Badge: ğŸŸ¢ Safe Zone         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ Current Location: At Home        â”‚
â”‚     123 Oak Street, Springfield    â”‚
â”‚     Last updated: 2 mins ago       â”‚
â”‚     [ğŸ”„ Refresh] [ğŸ—ºï¸ Directions]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš™ï¸ Edit Safe Zones [Opens Modal]  â”‚
â”‚  ğŸ“œ View History [Shows Entries]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ”§ **Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ:**

```dart
// 1. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Dropdown
int _selectedIndex = 0;

// 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
_Patient get _currentPatient => _patients[_selectedIndex];

// 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù…Ø§Ù†
bool _isSafe(_Patient p) =>
    p.safeZones.any((z) => _isInsideZone(p.position, z));

// 4. Refresh (Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø±ÙƒØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)
void _refreshSelected() {
  final r = Random();
  final p = _patients[_selectedIndex];
  final deltaLat = (r.nextDouble() - 0.5) / 5000;
  final deltaLng = (r.nextDouble() - 0.5) / 5000;
  setState(() {
    _patients[_selectedIndex] = p.copyWith(
      position: _LatLng(p.position.lat + deltaLat, p.position.lng + deltaLng),
      lastUpdated: DateTime.now(),
    );
  });
}

// 5. ÙØªØ­ Ù…Ø­Ø±Ø± Safe Zones
void _openAddSafeZoneSheet() { /* Ù…Ø­Ø±Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙÙŠ Modal */ }

// 6. ÙØªØ­ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
void _openHistorySheet(_Patient p) { /* Ø¹Ø±Ø¶ History */ }
```

#### âŒ **Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:**
1. **Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø«Ø§Ø¨ØªØ©** - 3 Ù…Ø±Ø¶Ù‰ ÙÙ‚Ø· Ù…ÙƒØªÙˆØ¨ÙŠÙ† Ø¨Ø§Ù„ÙƒÙˆØ¯
2. **Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Backend** - Ù„Ø§ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù…Ù† Server
3. **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©** - ØªÙØ¹Ø¯ÙÙ‘Ù„ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙ‚Ø·
4. **Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ©** - ÙŠØ¬Ø¨ refresh ÙŠØ¯ÙˆÙŠÙ‹Ø§
5. **Ø§Ù„Ø³Ø¬Ù„ Ø«Ø§Ø¨Øª** - Ù„Ø§ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©

---

## ğŸ“Š Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (Static)

### Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ø«Ù„Ø§Ø« Ø´Ø§Ø´Ø§Øª:

| Ø§Ù„Ù…ÙŠØ²Ø© | Patient | Family | Doctor |
|------|---------|--------|--------|
| **Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰/Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†** | 1 (Ù†ÙØ³ Ø§Ù„Ù…Ø±ÙŠØ¶) | 1 Ù…Ø±ÙŠØ¶ | 3 Ù…Ø±Ø¶Ù‰ |
| **Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª** | Hard-coded | Hard-coded | Hard-coded |
| **ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹** | Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (initState) | Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Refresh ÙŠØ¯ÙˆÙŠÙ‹Ø§) | Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Refresh ÙŠØ¯ÙˆÙŠÙ‹Ø§) |
| **ØªØ¹Ø¯ÙŠÙ„ Safe Zones** | âŒ ØºÙŠØ± Ù…Ù…ÙƒÙ† | âœ… Ù…Ù…ÙƒÙ† (Session) | âœ… Ù…Ù…ÙƒÙ† (Session) |
| **Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª** | âŒ | âŒ (ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙ‚Ø·) | âŒ (ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙ‚Ø·) |
| **Ø¥Ø¶Ø§ÙØ© Zones Ø¬Ø¯ÙŠØ¯Ø©** | âŒ | âœ… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ (Session) | âœ… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ (Session) |
| **Ø§Ù„Ø³Ø¬Ù„ (History)** | âŒ | âœ… (Static 4 entries) | âœ… (Static 2-3 entries) |
| **Emergency Contact** | Hard-coded | âŒ | âŒ |
| **Ø§ØªØµØ§Ù„ Backend** | âŒ | âŒ | âŒ |
| **Real-time Updates** | âŒ | âŒ | âŒ |

---

## âœ… ÙƒÙŠÙÙŠØ© ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©

### ğŸ¯ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:
```
Static (Hard-coded) â†’ Dynamic (API/Database)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile App      â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚  Backend    â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚  Database    â”‚
â”‚                  â”‚       â”‚  Server     â”‚       â”‚  (Supabase)  â”‚
â”‚ - Patient        â”‚       â”‚             â”‚       â”‚              â”‚
â”‚ - Family         â”‚       â”‚ - APIs      â”‚       â”‚ - Users      â”‚
â”‚ - Doctor         â”‚       â”‚ - Real-time â”‚       â”‚ - Locations  â”‚
â”‚                  â”‚       â”‚ - WebSocket â”‚       â”‚ - SafeZones  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ - History    â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ù„Ù„ØªØ­Ø¯ÙŠØ«

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø¥Ù†Ø´Ø§Ø¡ Models ÙˆRepositories**

#### 1.1 Ø¥Ù†Ø´Ø§Ø¡ Models:

```dart
// lib/core/models/tracking_models.dart

// 1. Ù†Ù…ÙˆØ°Ø¬ Safe Zone
class SafeZone {
  final String id;                    // UUID Ù…Ù† Database
  final String patientId;             // Ø±Ø¨Ø· Ø§Ù„Ù…Ø±ÙŠØ¶
  final String name;                  // 'Home', 'Park'
  final String address;               // '123 Oak Street'
  final double lat;
  final double lng;
  final double radiusMeters;
  final bool isActive;
  final DateTime createdAt;
  final DateTime updatedAt;

  SafeZone({
    required this.id,
    required this.patientId,
    required this.name,
    required this.address,
    required this.lat,
    required this.lng,
    required this.radiusMeters,
    required this.isActive,
    required this.createdAt,
    required this.updatedAt,
  });

  // ØªØ­ÙˆÙŠÙ„ Ù…Ù† JSON (Ù…Ù† API)
  factory SafeZone.fromJson(Map<String, dynamic> json) => SafeZone(
    id: json['id'],
    patientId: json['patient_id'],
    name: json['name'],
    address: json['address'] ?? 'â€”',
    lat: (json['latitude'] as num).toDouble(),
    lng: (json['longitude'] as num).toDouble(),
    radiusMeters: (json['radius_meters'] as num).toDouble(),
    isActive: json['is_active'] ?? true,
    createdAt: DateTime.parse(json['created_at']),
    updatedAt: DateTime.parse(json['updated_at']),
  );

  // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ JSON (Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ API)
  Map<String, dynamic> toJson() => {
    'id': id,
    'patient_id': patientId,
    'name': name,
    'address': address,
    'latitude': lat,
    'longitude': lng,
    'radius_meters': radiusMeters,
    'is_active': isActive,
    'created_at': createdAt.toIso8601String(),
    'updated_at': updatedAt.toIso8601String(),
  };

  // Ù†Ø³Ø®Ø© Ù…Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª
  SafeZone copyWith({
    String? id,
    String? patientId,
    String? name,
    String? address,
    double? lat,
    double? lng,
    double? radiusMeters,
    bool? isActive,
    DateTime? createdAt,
    DateTime? updatedAt,
  }) => SafeZone(
    id: id ?? this.id,
    patientId: patientId ?? this.patientId,
    name: name ?? this.name,
    address: address ?? this.address,
    lat: lat ?? this.lat,
    lng: lng ?? this.lng,
    radiusMeters: radiusMeters ?? this.radiusMeters,
    isActive: isActive ?? this.isActive,
    createdAt: createdAt ?? this.createdAt,
    updatedAt: updatedAt ?? this.updatedAt,
  );
}

// 2. Ù†Ù…ÙˆØ°Ø¬ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶
class PatientLocation {
  final String id;                    // UUID
  final String patientId;             // Ø±Ø¨Ø· Ø§Ù„Ù…Ø±ÙŠØ¶
  final double latitude;
  final double longitude;
  final String? address;              // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¬ÙŠÙˆ-ÙƒÙˆØ¯ Ù…Ø¹ÙƒÙˆØ³)
  final double? accuracy;             // Ø¯Ù‚Ø© GPS Ø¨Ø§Ù„Ù…ØªØ±
  final DateTime timestamp;           // ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³

  PatientLocation({
    required this.id,
    required this.patientId,
    required this.latitude,
    required this.longitude,
    this.address,
    this.accuracy,
    required this.timestamp,
  });

  factory PatientLocation.fromJson(Map<String, dynamic> json) => PatientLocation(
    id: json['id'],
    patientId: json['patient_id'],
    latitude: (json['latitude'] as num).toDouble(),
    longitude: (json['longitude'] as num).toDouble(),
    address: json['address'],
    accuracy: json['accuracy'] != null ? (json['accuracy'] as num).toDouble() : null,
    timestamp: DateTime.parse(json['timestamp']),
  );

  Map<String, dynamic> toJson() => {
    'id': id,
    'patient_id': patientId,
    'latitude': latitude,
    'longitude': longitude,
    'address': address,
    'accuracy': accuracy,
    'timestamp': timestamp.toIso8601String(),
  };
}

// 3. Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ø¬Ù„
class LocationHistory {
  final String id;
  final String patientId;
  final String placeName;            // 'Home', 'Park'
  final String address;
  final double latitude;
  final double longitude;
  final DateTime arrivedAt;
  final DateTime? departedAt;        // null Ø¥Ø°Ø§ Ù„Ù… ÙŠØºØ§Ø¯Ø± Ø¨Ø¹Ø¯
  final Duration? duration;          // Ù…Ø¯Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©

  LocationHistory({
    required this.id,
    required this.patientId,
    required this.placeName,
    required this.address,
    required this.latitude,
    required this.longitude,
    required this.arrivedAt,
    this.departedAt,
    this.duration,
  });

  factory LocationHistory.fromJson(Map<String, dynamic> json) => LocationHistory(
    id: json['id'],
    patientId: json['patient_id'],
    placeName: json['place_name'],
    address: json['address'],
    latitude: (json['latitude'] as num).toDouble(),
    longitude: (json['longitude'] as num).toDouble(),
    arrivedAt: DateTime.parse(json['arrived_at']),
    departedAt: json['departed_at'] != null ? DateTime.parse(json['departed_at']) : null,
    duration: json['duration_minutes'] != null 
        ? Duration(minutes: json['duration_minutes']) 
        : null,
  );

  Map<String, dynamic> toJson() => {
    'id': id,
    'patient_id': patientId,
    'place_name': placeName,
    'address': address,
    'latitude': latitude,
    'longitude': longitude,
    'arrived_at': arrivedAt.toIso8601String(),
    'departed_at': departedAt?.toIso8601String(),
    'duration_minutes': duration?.inMinutes,
  };
}
```

#### 1.2 Ø¥Ù†Ø´Ø§Ø¡ Repository:

```dart
// lib/core/repositories/tracking_repository.dart

import 'package:supabase_flutter/supabase_flutter.dart';

class TrackingRepository {
  final SupabaseClient _supabase;

  TrackingRepository(this._supabase);

  // ========== Safe Zones ==========

  /// Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¹ÙŠÙ†
  Future<List<SafeZone>> getSafeZones(String patientId) async {
    try {
      final response = await _supabase
          .from('safe_zones')
          .select()
          .eq('patient_id', patientId)
          .order('created_at', ascending: false);

      return (response as List)
          .map((e) => SafeZone.fromJson(e))
          .toList();
    } catch (e) {
      throw Exception('Failed to fetch safe zones: $e');
    }
  }

  /// Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
  Future<SafeZone> createSafeZone(SafeZone zone) async {
    try {
      final response = await _supabase
          .from('safe_zones')
          .insert(zone.toJson())
          .select()
          .single();

      return SafeZone.fromJson(response);
    } catch (e) {
      throw Exception('Failed to create safe zone: $e');
    }
  }

  /// ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø©
  Future<SafeZone> updateSafeZone(SafeZone zone) async {
    try {
      final response = await _supabase
          .from('safe_zones')
          .update({
            'name': zone.name,
            'address': zone.address,
            'latitude': zone.lat,
            'longitude': zone.lng,
            'radius_meters': zone.radiusMeters,
            'is_active': zone.isActive,
            'updated_at': DateTime.now().toIso8601String(),
          })
          .eq('id', zone.id)
          .select()
          .single();

      return SafeZone.fromJson(response);
    } catch (e) {
      throw Exception('Failed to update safe zone: $e');
    }
  }

  /// Ø­Ø°Ù Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø©
  Future<void> deleteSafeZone(String zoneId) async {
    try {
      await _supabase
          .from('safe_zones')
          .delete()
          .eq('id', zoneId);
    } catch (e) {
      throw Exception('Failed to delete safe zone: $e');
    }
  }

  // ========== Location Updates ==========

  /// Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ù„ÙŠ Ù„Ù„Ù€ Database
  Future<void> updateLocation({
    required String patientId,
    required double latitude,
    required double longitude,
    String? address,
    double? accuracy,
  }) async {
    try {
      await _supabase.from('location_updates').insert({
        'patient_id': patientId,
        'latitude': latitude,
        'longitude': longitude,
        'address': address,
        'accuracy': accuracy,
        'timestamp': DateTime.now().toIso8601String(),
      });
    } catch (e) {
      throw Exception('Failed to update location: $e');
    }
  }

  /// Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ù…Ø¹Ø±ÙˆÙ Ù„Ù„Ù…Ø±ÙŠØ¶
  Future<PatientLocation?> getLastLocation(String patientId) async {
    try {
      final response = await _supabase
          .from('location_updates')
          .select()
          .eq('patient_id', patientId)
          .order('timestamp', ascending: false)
          .limit(1);

      if (response.isEmpty) return null;
      return PatientLocation.fromJson(response.first);
    } catch (e) {
      throw Exception('Failed to fetch last location: $e');
    }
  }

  /// Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
  Future<List<LocationHistory>> getLocationHistory(
    String patientId, {
    int days = 7,
  }) async {
    try {
      final since = DateTime.now().subtract(Duration(days: days));
      final response = await _supabase
          .from('location_history')
          .select()
          .eq('patient_id', patientId)
          .gte('arrived_at', since.toIso8601String())
          .order('arrived_at', ascending: false);

      return (response as List)
          .map((e) => LocationHistory.fromJson(e))
          .toList();
    } catch (e) {
      throw Exception('Failed to fetch location history: $e');
    }
  }

  // ========== Real-time Streams ==========

  /// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© (WebSocket)
  Stream<PatientLocation> watchLocationUpdates(String patientId) {
    return _supabase
        .from('location_updates')
        .on(RealtimeListenTypes.postgresChanges,
            event: RealtimeListenTypes.all,
            schema: 'public',
            table: 'location_updates',
            filter: PostgresChangeFilter(
              type: PostgresChangeFilterType.eq,
              column: 'patient_id',
              value: patientId,
            ))
        .asyncMap((event) async {
          final data = event.payload['new'] as Map<String, dynamic>;
          return PatientLocation.fromJson(data);
        });
  }

  /// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Safe Zones
  Stream<SafeZone> watchSafeZones(String patientId) {
    return _supabase
        .from('safe_zones')
        .on(RealtimeListenTypes.postgresChanges,
            event: RealtimeListenTypes.all,
            schema: 'public',
            table: 'safe_zones',
            filter: PostgresChangeFilter(
              type: PostgresChangeFilterType.eq,
              column: 'patient_id',
              value: patientId,
            ))
        .asyncMap((event) async {
          final data = event.payload['new'] as Map<String, dynamic>;
          return SafeZone.fromJson(data);
        });
  }
}
```

---

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¥Ù†Ø´Ø§Ø¡ BLoC/Cubit Ù„Ù„ØªØªØ¨Ø¹**

```dart
// lib/screens/patient/live_tracking/cubit/patient_tracking_cubit.dart

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:geolocator/geolocator.dart';
import 'package:geocoding/geocoding.dart';

enum TrackingStatus { initial, loading, loaded, error }

class PatientTrackingState {
  final TrackingStatus status;
  final Position? currentPosition;
  final String? address;
  final DateTime? lastUpdated;
  final List<SafeZone> safeZones;
  final bool isInsideSafeZone;
  final String? errorMessage;

  PatientTrackingState({
    required this.status,
    this.currentPosition,
    this.address,
    this.lastUpdated,
    required this.safeZones,
    required this.isInsideSafeZone,
    this.errorMessage,
  });

  PatientTrackingState copyWith({
    TrackingStatus? status,
    Position? currentPosition,
    String? address,
    DateTime? lastUpdated,
    List<SafeZone>? safeZones,
    bool? isInsideSafeZone,
    String? errorMessage,
  }) => PatientTrackingState(
    status: status ?? this.status,
    currentPosition: currentPosition ?? this.currentPosition,
    address: address ?? this.address,
    lastUpdated: lastUpdated ?? this.lastUpdated,
    safeZones: safeZones ?? this.safeZones,
    isInsideSafeZone: isInsideSafeZone ?? this.isInsideSafeZone,
    errorMessage: errorMessage,
  );
}

class PatientTrackingCubit extends Cubit<PatientTrackingState> {
  final TrackingRepository _trackingRepository;
  final String _patientId;
  StreamSubscription? _locationSubscription;
  StreamSubscription? _safeZonesSubscription;
  Timer? _locationUpdateTimer;

  PatientTrackingCubit(
    this._trackingRepository,
    this._patientId,
  ) : super(PatientTrackingState(
    status: TrackingStatus.initial,
    safeZones: [],
    isInsideSafeZone: true,
  ));

  /// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
  Future<void> initializeTracking() async {
    emit(state.copyWith(status: TrackingStatus.loading));
    try {
      // 1. Ø¬Ù„Ø¨ Safe Zones
      final zones = await _trackingRepository.getSafeZones(_patientId);
      emit(state.copyWith(safeZones: zones));

      // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„
      await _updateLocation();

      // 3. Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
      _startRealTimeUpdates();

      emit(state.copyWith(status: TrackingStatus.loaded));
    } catch (e) {
      emit(state.copyWith(
        status: TrackingStatus.error,
        errorMessage: e.toString(),
      ));
    }
  }

  /// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§
  Future<void> refreshLocation() async {
    await _updateLocation();
  }

  /// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
  Future<void> _updateLocation() async {
    try {
      // Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
      final permission = await Geolocator.checkPermission();
      if (permission == LocationPermission.denied ||
          permission == LocationPermission.deniedForever) {
        await Geolocator.requestPermission();
        return;
      }

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
      final position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.best,
      );

      // Ø¹ÙƒØ³ Ø§Ù„Ø¬ÙŠÙˆ-ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      String? addr;
      try {
        final placemarks = await placemarkFromCoordinates(
          position.latitude,
          position.longitude,
        );
        if (placemarks.isNotEmpty) {
          final p = placemarks.first;
          addr = [
            if (p.street != null && p.street!.isNotEmpty) p.street,
            if (p.locality != null && p.locality!.isNotEmpty) p.locality,
          ].whereType<String>().where((e) => e.isNotEmpty).join(', ');
        }
      } catch (_) {}

      // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ Database
      await _trackingRepository.updateLocation(
        patientId: _patientId,
        latitude: position.latitude,
        longitude: position.longitude,
        address: addr,
        accuracy: position.accuracy,
      );

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù…Ø§Ù†
      final isInside = _isInsideSafeZone(position.latitude, position.longitude);

      emit(state.copyWith(
        currentPosition: position,
        address: addr,
        lastUpdated: DateTime.now(),
        isInsideSafeZone: isInside,
      ));
    } catch (e) {
      emit(state.copyWith(
        errorMessage: 'Failed to update location: $e',
      ));
    }
  }

  /// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
  void _startRealTimeUpdates() {
    // 1. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Safe Zones Ù…Ù† Database
    _safeZonesSubscription?.cancel();
    _safeZonesSubscription = _trackingRepository
        .watchSafeZones(_patientId)
        .listen((zone) {
      // ØªØ­Ø¯ÙŠØ« Safe Zones
      final updatedZones = state.safeZones.map((z) {
        return z.id == zone.id ? zone : z;
      }).toList();
      emit(state.copyWith(safeZones: updatedZones));
    });

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© (ÙŠÙ…ÙƒÙ† ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØªØ±Ø©)
    _locationUpdateTimer?.cancel();
    _locationUpdateTimer = Timer.periodic(
      const Duration(seconds: 30),
      (_) async => await _updateLocation(),
    );
  }

  /// Ø­Ø³Ø§Ø¨ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø©
  bool _isInsideSafeZone(double lat, double lng) {
    for (final zone in state.safeZones) {
      if (!zone.isActive) continue;
      final distance = _haversineDistance(lat, lng, zone.lat, zone.lng);
      if (distance <= zone.radiusMeters) return true;
    }
    return false;
  }

  /// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† (Haversine)
  double _haversineDistance(
    double lat1, double lng1, double lat2, double lng2) {
    const r = 6371000.0; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„Ù…ØªØ±
    final dLat = _deg2rad(lat2 - lat1);
    final dLng = _deg2rad(lng2 - lng1);
    final a = sin(dLat / 2) * sin(dLat / 2) +
        cos(_deg2rad(lat1)) *
            cos(_deg2rad(lat2)) *
            sin(dLng / 2) *
            sin(dLng / 2);
    final c = 2 * atan2(sqrt(a), sqrt(1 - a));
    return r * c;
  }

  double _deg2rad(double d) => d * pi / 180.0;

  /// Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
  Future<void> addSafeZone(SafeZone zone) async {
    try {
      final newZone = await _trackingRepository.createSafeZone(zone);
      emit(state.copyWith(
        safeZones: [...state.safeZones, newZone],
      ));
    } catch (e) {
      emit(state.copyWith(errorMessage: 'Failed to add safe zone: $e'));
    }
  }

  /// ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø©
  Future<void> updateSafeZone(SafeZone zone) async {
    try {
      final updated = await _trackingRepository.updateSafeZone(zone);
      final updatedZones = state.safeZones.map((z) {
        return z.id == updated.id ? updated : z;
      }).toList();
      emit(state.copyWith(safeZones: updatedZones));
    } catch (e) {
      emit(state.copyWith(errorMessage: 'Failed to update safe zone: $e'));
    }
  }

  /// Ø­Ø°Ù Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø©
  Future<void> deleteSafeZone(String zoneId) async {
    try {
      await _trackingRepository.deleteSafeZone(zoneId);
      final updatedZones = state.safeZones.where((z) => z.id != zoneId).toList();
      emit(state.copyWith(safeZones: updatedZones));
    } catch (e) {
      emit(state.copyWith(errorMessage: 'Failed to delete safe zone: $e'));
    }
  }

  @override
  Future<void> close() {
    _locationSubscription?.cancel();
    _safeZonesSubscription?.cancel();
    _locationUpdateTimer?.cancel();
    return super.close();
  }
}
```

---

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Supabase)**

```sql
-- 1. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¢Ù…Ù†Ø©
CREATE TABLE IF NOT EXISTS safe_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  patient_id UUID NOT NULL REFERENCES auth.users(id),
  name TEXT NOT NULL,
  address TEXT,
  latitude DOUBLE PRECISION NOT NULL,
  longitude DOUBLE PRECISION NOT NULL,
  radius_meters DOUBLE PRECISION NOT NULL DEFAULT 200,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT unique_patient_zone UNIQUE(patient_id, name)
);

-- 2. Ø¬Ø¯ÙˆÙ„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
CREATE TABLE IF NOT EXISTS location_updates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  patient_id UUID NOT NULL REFERENCES auth.users(id),
  latitude DOUBLE PRECISION NOT NULL,
  longitude DOUBLE PRECISION NOT NULL,
  address TEXT,
  accuracy DOUBLE PRECISION,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„ (ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ù€ Trigger Ø£Ùˆ Backend Logic)
CREATE TABLE IF NOT EXISTS location_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  patient_id UUID NOT NULL REFERENCES auth.users(id),
  place_name TEXT,
  address TEXT,
  latitude DOUBLE PRECISION NOT NULL,
  longitude DOUBLE PRECISION NOT NULL,
  arrived_at TIMESTAMP WITH TIME ZONE NOT NULL,
  departed_at TIMESTAMP WITH TIME ZONE,
  duration_minutes INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Ø§Ù„ÙÙ‡Ø§Ø±Ø³
CREATE INDEX idx_safe_zones_patient ON safe_zones(patient_id);
CREATE INDEX idx_location_updates_patient ON location_updates(patient_id, timestamp DESC);
CREATE INDEX idx_location_history_patient ON location_history(patient_id, arrived_at DESC);

-- 5. ØªÙØ¹ÙŠÙ„ Realtime (ÙÙŠ Supabase)
ALTER TABLE safe_zones REPLICA IDENTITY FULL;
ALTER TABLE location_updates REPLICA IDENTITY FULL;
```

---

## ğŸ“ Ø§Ù„Ø®Ù„Ø§ØµØ©

### **Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Static):**
- âœ— Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØªÙˆØ¨Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯
- âœ— Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ©
- âœ— Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØªÙÙÙ‚Ø¯ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
- âœ— Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Backend

### **Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (Dynamic):**
- âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Database
- âœ… ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ø¨Ø± WebSocket
- âœ… Ø­ÙØ¸ Ø¯Ø§Ø¦Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
- âœ… Ø§ØªØµØ§Ù„ Backend Ø¢Ù…Ù†
- âœ… ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Doctor, Family, Patient)

### **Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ù‚Ø¨Ù„Ø©:**
1. Ø¥Ù†Ø´Ø§Ø¡ Models Ùˆ Repository
2. Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Supabase)
3. Ø¨Ù†Ø§Ø¡ BLoC/Cubit
4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… BLoC
5. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©

---

**ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ:** 22 Ù†ÙˆÙÙ…Ø¨Ø± 2025
